<?php

/**
 * @author      OA Wu <comdan66@gmail.com>
 * @copyright   Copyright (c) 2013 - 2017, OACI
 * @license     http://opensource.org/licenses/MIT  MIT License
 * @link        https://www.ioa.tw/
 */

include_once 'lib' . DIRECTORY_SEPARATOR . 'base.php';
include_once BASEPATH . 'core' . DIRECTORY_SEPARATOR . 'Load.php';

Load::sysCore ('Common.php', true);
Load::sysCore ('Benchmark.php' , true, "Benchmark::init ();");
Load::sysCore ('Exceptions.php', true, "Exceptions::init ();");
Load::sysFunc ('file.php', true);

$file = array_shift ($argv);

if (!function_exists ('headerText')) {
  function headerText () {
    system ('clear');
    echo cc ('â•”' . str_repeat ('â•', CLI_LEN - 2) . 'â•—', 'N') . "\n";
    echo cc ('â•‘' . str_repeat (' ', CLI_LEN - 2) . 'â•‘', 'N') . "\n";
    echo cc ('â•‘', 'N') . cc ('  æ­¡è¿ä½¿ç”¨ OACI åˆå§‹åŒ–å·¥å…·', 'y') . cc (' v1.0', 'N') . str_repeat (' ', CLI_LEN - 33) . cc ('â•‘', 'N') . "\n";
    echo cc ('â•‘', 'N') . str_repeat (' ', CLI_LEN - 15) . '    ' . cc ('by', 'N') . ' ' . cc ('OA Wu ', 'W') . cc ('â•‘', 'N') . "\n";
  }
}

if (!function_exists ('writeIndex')) {
  function writeIndex ($path) {
    return file_exists ($path .=  DIRECTORY_SEPARATOR . 'index.html') ? true : write_file ($path, "<!DOCTYPE html>\n" . "<html>\n" . "<head>\n" . "  <meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\" />\n" . "  <title>403 ç¦æ­¢è¨ªå•</title>\n" . "</head>\n" . "<body>\n" . "\n" . "<p>æ‚¨ç„¡æ¬ŠæŸ¥çœ‹è©²ç¶²é ã€‚</p>\n" . "\n" . "</body>\n" . "</html>");
  }
}

if (!function_exists ('myMkdir')) {
  function myMkdir ($path) {
    $oldmask = umask (0);
    $return = @mkdir ($path, 0777, true);
    umask ($oldmask);

    if (!$return) return false;

    return writeIndex ($path);
  }
}

if (!function_exists ('mkCmd')) {
  function mkCmd () {
    $link = 'cmd';
    $target = 'sys/cmd';
    
    !file_exists (FCPATH . $link) || @unlink (FCPATH . $link);

    if (!@symlink (FCPATH . $target, FCPATH . $link))
      return false;

    if (!file_exists (FCPATH . $link))
      return false;

    $oldmask = umask (0);
    @chmod ($link, 0777);
    umask ($oldmask);

    return true;
  }
}

$dbp = APPPATH . 'config' . DIRECTORY_SEPARATOR;

if (!is_really_writable (FCPATH)) {
  echo cc ('+', 'N') . cc (str_repeat ('â”€', CLI_LEN - 2), 'N') . cc ('+', 'N') . "\n";
  echo cc ('|', 'N') . cc (str_repeat (' ', CLI_LEN - 2), null, 'R') . cc ('|', 'N') . "\n";
  echo cc ('|', 'N') . cc (str_repeat (' ', 6), null, 'R') . cc ('éŒ¯èª¤ï¼', 'Y', 'R') . cc ('å°ˆæ¡ˆç›®éŒ„ç„¡æ³•å¯«å…¥ï¼Œ', 'w', 'R') . cc ('è«‹ç¢ºèªè³‡æ–™å¤¾æ¬Šé™', 'W', 'R') . cc ('ï¼Œ', 'w', 'R') . cc ('ç›®å‰æ¬Šé™ï¼š', null, 'R') . cc (substr (sprintf ('%o', fileperms (FCPATH)), -4), 'W', 'R') . cc (str_repeat (' ', CLI_LEN - 2 - 6 - 56), null, 'R') . cc ('|', 'N') . "\n";
  echo cc ('|', 'N') . cc (str_repeat (' ', 34), null, 'R') . cc ('^^^^^^^^^^^^^^^^', 'R', 'R') . cc (str_repeat (' ', CLI_LEN - 2 - 34 - 16), null, 'R') . cc ('|', 'N') . "\n";
  echo cc ('+', 'N') . cc (str_repeat ('â”€', CLI_LEN - 2), 'N') . cc ('+', 'N') . "\n";
  echo "\n";
  exit();
}

if (!is_really_writable ($dbp)) {
  echo cc ('+', 'N') . cc (str_repeat ('â”€', CLI_LEN - 2), 'N') . cc ('+', 'N') . "\n";
  echo cc ('|', 'N') . cc (str_repeat (' ', CLI_LEN - 2), null, 'R') . cc ('|', 'N') . "\n";
  echo cc ('|', 'N') . cc (str_repeat (' ', 6), null, 'R') . cc ('éŒ¯èª¤ï¼', 'Y', 'R') . cc ('Config ç›®éŒ„ç„¡æ³•å¯«å…¥ï¼Œ', 'w', 'R') . cc ('è«‹ç¢ºèªè³‡æ–™å¤¾æ¬Šé™', 'W', 'R') . cc ('ï¼Œ', 'w', 'R') . cc ('ç›®å‰æ¬Šé™ï¼š', null, 'R') . cc (substr (sprintf ('%o', fileperms ($dbp)), -4), 'W', 'R') . cc (str_repeat (' ', CLI_LEN - 2 - 6 - 59), null, 'R') . cc ('|', 'N') . "\n";
  echo cc ('|', 'N') . cc (str_repeat (' ', 34), null, 'R') . cc ('^^^^^^^^^^^^^^^^', 'R', 'R') . cc (str_repeat (' ', CLI_LEN - 2 - 34 - 16), null, 'R') . cc ('|', 'N') . "\n";
  echo cc ('+', 'N') . cc (str_repeat ('â”€', CLI_LEN - 2), 'N') . cc ('+', 'N') . "\n";
  echo "\n";
  exit(); 
}


function dbText ($env = 0, $host = null, $acc = null, $psw = null, $table = null, $charset = null) {
  headerText ();
  echo cc ('â• â•â•â•â•â•â•â•¦' . str_repeat ('â•', CLI_LEN - 9) . 'â•£', 'N') . "\n";
  echo cc ('â•‘', 'N') . ' é¸é … ' . cc ('â•‘', 'N') . ' é–‹ç™¼ç’°å¢ƒ ' . str_repeat (' ', CLI_LEN - 19) . cc ('â•‘', 'N') . "\n";
  echo cc ('â•Ÿâ”€â”€â”€â”€â”€â”€â•«' . str_repeat ('â”€', CLI_LEN - 9) . 'â•¢', 'N') . "\n";
  echo cc ('â•‘', 'N') . ' ' . cc ($env == '1' ? 'âœ' : ' ', 'y') . cc (' 1. ', $env == '1' ? 'Y' : null) . cc ('â•‘', 'N') . cc (' æ­£å¼ç’°å¢ƒ ', $env == '1' ? 'Y' : null) . cc ('(production)', $env == '1' ? 'y' : 'N') . str_repeat (' ', CLI_LEN - 31) . cc ('â•‘', 'N') . "\n";
  echo cc ('â•‘', 'N') . ' ' . cc ($env == '2' ? 'âœ' : ' ', 'y') . cc (' 2. ', $env == '2' ? 'Y' : null) . cc ('â•‘', 'N') . cc (' é–‹ç™¼ç’°å¢ƒ ', $env == '2' ? 'Y' : null) . cc ('(development)', $env == '2' ? 'y' : 'N') . str_repeat (' ', CLI_LEN - 32) . cc ('â•‘', 'N') . "\n";

  if (!$env)
    return;

  if (!$host)
    echo cc ('â•šâ•â•â•â•â•â•â•©' . str_repeat ('â•', CLI_LEN - 9) . 'â•', 'N') . "\n" . cc ('â•”' . str_repeat ('â•', CLI_LEN - 2) . 'â•—', 'N') . "\n";
  else
    echo cc ('â• â•â•â•â•â•â•â•©' . str_repeat ('â•', CLI_LEN - 9) . 'â•£', 'N') . "\n";
  
  echo cc ('â•‘', 'N') . " è¨­å®šè³‡æ–™åº« " . str_repeat (' ', CLI_LEN - 14) . cc('â•‘', 'N') . "\n";

  if (!$host)
    return print (cc ('â•š' . str_repeat ('â•', CLI_LEN - 2) . 'â•', 'N') . "\n");
  else
    echo cc ('â• ' . str_repeat ('â•', 16) . 'â•¦' . str_repeat ('â•', CLI_LEN - 2 - 16 - 1) . 'â•£', 'N') . "\n";

  if ($host)
    echo cc ('â•‘', 'N') . " ä½å€" . cc ('(hostname) â•‘', 'N') . ' ' . sprintf ('%-' . (CLI_LEN - 20) . 's', $host) . cc('â•‘', 'N') . "\n";
  
  if ($host && !$acc)
    return print (cc ('â•š' . str_repeat ('â•', 16) . 'â•©' . str_repeat ('â•', CLI_LEN - 2 - 16 - 1) . 'â•', 'N') . "\n");
  else
    echo cc ('â•Ÿ' . str_repeat ('â”€', 16) . 'â•«' . str_repeat ('â”€', CLI_LEN - 2 - 16 - 1) . 'â•¢', 'N') . "\n";
  
  if ($acc)
    echo cc ('â•‘', 'N') . " å¸³è™Ÿ" . cc ('(username) â•‘', 'N') . ' ' . sprintf ('%-' . (CLI_LEN - 20) . 's', $acc) . cc('â•‘', 'N') . "\n";
  
  if ($host && $acc && !$psw)
    return print (cc ('â•š' . str_repeat ('â•', 16) . 'â•©' . str_repeat ('â•', CLI_LEN - 2 - 16 - 1) . 'â•', 'N') . "\n");
  else
    echo cc ('â•Ÿ' . str_repeat ('â”€', 16) . 'â•«' . str_repeat ('â”€', CLI_LEN - 2 - 16 - 1) . 'â•¢', 'N') . "\n";
  
  if ($psw)
    echo cc ('â•‘', 'N') . " å¯†ç¢¼" . cc ('(password) â•‘', 'N') . ' ' . sprintf ('%-' . (CLI_LEN - 20) . 's', $psw) . cc('â•‘', 'N') . "\n";
  
  if ($host && $acc && $psw && !$table)
    return print (cc ('â•š' . str_repeat ('â•', 16) . 'â•©' . str_repeat ('â•', CLI_LEN - 2 - 16 - 1) . 'â•', 'N') . "\n");
  else
    echo cc ('â•Ÿ' . str_repeat ('â”€', 16) . 'â•«' . str_repeat ('â”€', CLI_LEN - 2 - 16 - 1) . 'â•¢', 'N') . "\n";
  
  if ($table)
    echo cc ('â•‘', 'N') . " åç¨±" . cc ('(database) â•‘', 'N') . ' ' . sprintf ('%-' . (CLI_LEN - 20) . 's', $table) . cc('â•‘', 'N') . "\n";
  
  
  if ($host && $acc && $psw && $table && !$charset)
    return print (cc ('â•š' . str_repeat ('â•', 16) . 'â•©' . str_repeat ('â•', CLI_LEN - 2 - 16 - 1) . 'â•', 'N') . "\n");
  else
    echo cc ('â•Ÿ' . str_repeat ('â”€', 16) . 'â•«' . str_repeat ('â”€', CLI_LEN - 2 - 16 - 1) . 'â•¢', 'N') . "\n";
  
  if ($charset)
    echo cc ('â•‘', 'N') . " ç·¨ç¢¼" . cc ('(char set) â•‘', 'N') . ' ' . sprintf ('%-' . (CLI_LEN - 20) . 's', $charset) . cc('â•‘', 'N') . "\n";
  
  if ($host && $acc && $psw && $table && $charset)
    return print (cc ('â•š' . str_repeat ('â•', 16) . 'â•©' . str_repeat ('â•', CLI_LEN - 2 - 16 - 1) . 'â•', 'N') . "\n");
}

do {
  if (!isset ($env, $host, $acc, $psw, $table)) {
    do {
      dbText ();
      echo cc ('â•Ÿ â”€ â”€ â”€â•‘â”€' . str_repeat (' â”€', (CLI_LEN - 9) / 2) . 'â•‘', 'N') . "\n";
      echo cc ('â•‘', 'N') . cc ('   q. ', 'W') . cc ('â•‘', 'N') . ' æ²’äº‹ï¼ŒæŒ‰éŒ¯.. é›¢é–‹æœ¬ç¨‹å¼ ' . str_repeat (' ', CLI_LEN - 23 - 11) . cc ('â•‘', 'N') . "\n";
      echo cc ('â•šâ•â•â•â•â•â•â•©' . str_repeat ('â•', CLI_LEN - 9) . 'â•', 'N') . "\n";      
      echo "\n";
      echo ' ' . cc ('âœ', 'G') . ' è«‹è¼¸å…¥æ‚¨çš„é¸é …' . cc ('(q)', 'N') . 'ï¼š';

      ($env = trim (fgets (STDIN))) || $env = 'q';
    } while (!in_array (strtolower ($env), array ('1', '2', 'q')));

    if ($env == 'q') {
      echo "\n";
      echo cc (str_repeat ('â•', CLI_LEN), 'N') . "\n\n";
      echo "  ğŸ˜Š  å¥½çš„ï¼ä¸‹æ¬¡åˆ¥å†æŒ‰éŒ¯å›‰ï¼ŒæœŸå¾…æ‚¨ä¸‹æ¬¡å†ä½¿ç”¨ï¼ŒğŸ‘‹  " . cc ('æ°æ°', 'W') . "ï½  \n\n";
      echo cc (str_repeat ('â•', CLI_LEN), 'N') . "\n\n";
      exit;
    }

    do {
      dbText ($env);
      echo "\n";
      echo ' ' . cc ('âœ', 'G') . ' è«‹è¼¸å…¥ä¸»æ©Ÿ' . cc ('(127.0.0.1)', 'N') . 'ï¼š';
      ($host = trim (fgets (STDIN))) || $host = '127.0.0.1';
    } while (!$host);

    do {
      dbText ($env, $host);
      echo "\n";
      echo ' ' . cc ('âœ', 'G') . ' è«‹è¼¸å…¥å¸³è™Ÿ' . cc ('(root)', 'N') . 'ï¼š';
      ($acc = trim (fgets (STDIN))) || $acc = 'root';
    } while (!$acc);

    do {
      dbText ($env, $host, $acc);
      echo "\n";
      echo ' ' . cc ('âœ', 'G') . ' è«‹è¼¸å…¥å¯†ç¢¼' . 'ï¼š';
    } while (!$psw = trim (fgets (STDIN)));

    do {
      dbText ($env, $host, $acc, $psw);
      echo "\n";
      echo ' ' . cc ('âœ', 'G') . ' è«‹è¼¸å…¥è³‡æ–™åº«åç¨±' . 'ï¼š';
    } while (!$table = trim (fgets (STDIN)));

    do {
      dbText ($env, $host, $acc, $psw, $table);
      echo "\n";
      echo ' ' . cc ('âœ', 'G') . ' è«‹è¼¸å…¥ç·¨ç¢¼æ–¹å¼' . cc ('(utf8)', 'N') . 'ï¼š';
      ($charset = trim (fgets (STDIN))) || $charset = 'utf8';
    } while (!$charset);
  }
  dbText ($env, $host, $acc, $psw, $table, $charset);

  echo "\n";
  echo ' ' . cc ('âœ', 'G') . ' ç¢ºèªä»¥ä¸Šè³‡è¨Šæ˜¯å¦æ­£ç¢º' . cc ('[Yï¼šæ­£ç¢º, nï¼šé‡å¡«]', 'N') . 'ï¼Ÿ';
  ($check = strtolower (trim (fgets (STDIN)))) == 'n' && $env = $host = $acc = $psw = $table = $charset = null;
} while ($check != 'y');

echo "\n";
echo "" . cc (str_repeat ('â”€ ', CLI_LEN / 2), 'N') . "\n";
echo ' ' . cc ('â—', 'G') . " å¯«å…¥ç’°å¢ƒè¨­å®š - " . (write_file (FCPATH . '_env.php', "<?php\n" . "\n" . "/**\n" . " * @author      OA Wu <comdan66@gmail.com>\n" . " * @copyright   Copyright (c) 2013 - 2017, OACI\n" . " * @license     http://opensource.org/licenses/MIT  MIT License\n" . " * @link        https://www.ioa.tw/\n" . " */\n" . "\n" . "define ('ENVIRONMENT', " . ($env == '2' ? "'production'" : "'development'") . ");", FOPEN_READ_WRITE_CREATE_DESTRUCTIVE) ? cc ('æˆåŠŸ', 'g') : cc ('å¤±æ•—', 'r')) . "\n";
echo ' ' . cc ('â—', 'G') . " å»ºç«‹ cmd æ·å¾‘ - " . (mkCmd () ? cc ('æˆåŠŸ', 'g') : cc ('å¤±æ•—', 'r')) . "\n";
echo ' ' . cc ('â—', 'G') . " å¯«å…¥è³‡æ–™åº«è¨­å®š - " . (write_file ($dbp . 'database' . EXT, "<?php defined ('BASEPATH') || exit ('æ­¤æª”æ¡ˆä¸å…è¨±è®€å–ã€‚');\n" . "\n" . "/**\n" . " * @author      OA Wu <comdan66@gmail.com>\n" . " * @copyright   Copyright (c) 2013 - 2017, OACI\n" . " * @license     http://opensource.org/licenses/MIT  MIT License\n" . " * @link        https://www.ioa.tw/\n" . " */\n" . "\n" . "return array (\n" . "    'active_group' => 'default',\n" . "    'groups' => array (\n" . "        'default' => array (\n" . "          'hostname' => '" . $host . "',\n" . "          'username' => '" . $acc . "',\n" . "          'password' => '" . $psw . "',\n" . "          'database' => '" . $table . "',\n" . "          'dbdriver' => 'mysql',\n" . "          'char_set' => '" . $charset . "',\n" . "          'dbcollat' => '" . $charset . "_general_ci',\n" . "          )\n" . "      )\n" . "  );\n", FOPEN_READ_WRITE_CREATE_DESTRUCTIVE) ? cc ('æˆåŠŸ', 'g') : cc ('å¤±æ•—', 'r')) . "\n";

echo "" . cc (str_repeat ('â”€ ', CLI_LEN / 2), 'N') . "\n";
$dirs = array ('log', 'cache', 'upload', 'session');
foreach ($dirs as $dir)
  echo ' ' . cc ('â—', 'G') . " æ–°å¢ " . cc ($dir, 'W') . ' è³‡æ–™å¤¾ - ' . (!is_file ($path = FCPATH . $dir) ? !is_dir ($path) ? myMkdir (FCPATH . $dir) ? cc ('æˆåŠŸ', 'g') : cc ('å¤±æ•—', 'r') : (file_exists ($path . DIRECTORY_SEPARATOR . 'index.html') ? cc ('æˆåŠŸ', 'g') . cc ('(å­˜åœ¨)', 'N') : (writeIndex ($path) ? cc ('æˆåŠŸ', 'g') . cc ('(å­˜åœ¨ï¼Œè£œå…… index.html)', 'N') : cc ('(å­˜åœ¨ï¼Œè£œå…… index.html å¤±æ•—)', 'R'))) : cc ('å¤±æ•—', 'r')) . "\n";

echo "" . cc (str_repeat ('â”€ ', CLI_LEN / 2), 'N') . "\n";

echo "\n";
echo ' ' . cc ('âœ', 'R') . " ğŸ‰  " . cc ($env == '2' ? 'æ­£å¼ç’°å¢ƒ' : 'é–‹ç™¼ç’°å¢ƒ', 'W') . cc ($env == '2' ? '(production)' : '(development)', 'N') . " åˆå§‹åŒ–" . cc ('é †åˆ©å®Œæˆ', 'W') . 'å›‰ï¼Œ' . ($env == '2' ? 'å¿«é–‹å•Ÿç¶²å€ç¢ºèªä¸€ä¸‹å§' : 'å¯ä»¥é–‹å§‹å¯«ç¨‹å¼å•¦') . "ï¼\n";
echo "\n";
exit;
