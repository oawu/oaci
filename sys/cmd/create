<?php

/**
 * @author      OA Wu <comdan66@gmail.com>
 * @copyright   Copyright (c) 2013 - 2017, OACI
 * @license     http://opensource.org/licenses/MIT  MIT License
 * @link        https://www.ioa.tw/
 */

include_once 'lib' . DIRECTORY_SEPARATOR . 'base.php';
include_once BASEPATH . 'core' . DIRECTORY_SEPARATOR . 'Load.php';

Load::sysCore ('Common.php', true);
Load::sysCore ('Benchmark.php' , true, "Benchmark::init ();");
Load::sysCore ('Exceptions.php', true, "Exceptions::init ();");
Load::sysFunc ('file.php', true);

if (!function_exists ('headerText')) {
  function headerText ($cho = 0) {
    system ('clear');
    echo cc ('â•”' . str_repeat ('â•', CLI_LEN - 2) . 'â•—', 'N') . "\n";
    echo cc ('â•‘' . str_repeat (' ', CLI_LEN - 2) . 'â•‘', 'N') . "\n";
    echo cc ('â•‘', 'N') . cc ('  æ­¡è¿ä½¿ç”¨ OACI Create å·¥å…·', 'y') . cc (' v1.0', 'N') . str_repeat (' ', CLI_LEN - 34) . cc ('â•‘', 'N') . "\n";
    echo cc ('â•‘', 'N') . str_repeat (' ', CLI_LEN - 15) . '    ' . cc ('by', 'N') . ' ' . cc ('OA Wu ', 'W') . cc ('â•‘', 'N') . "\n";
    echo cc ('â• â•â•â•â•â•â•â•¦' . str_repeat ('â•', CLI_LEN - 9) . 'â•£', 'N') . "\n";
    echo cc ('â•‘', 'N') . ' é¸é … ' . cc ('â•‘', 'N') . ' åç¨± ' . str_repeat (' ', CLI_LEN - 15) . cc ('â•‘', 'N') . "\n";
    echo cc ('â•Ÿâ”€â”€â”€â”€â”€â”€â•«' . str_repeat ('â”€', CLI_LEN - 9) . 'â•¢', 'N') . "\n";
    echo cc ('â•‘', 'N') . ' ' . cc ($cho == '1' ? 'âœ' : ' ', 'y') . cc (' 1. ', $cho == '1' ? 'Y' : null) . cc ('â•‘', 'N') . cc (' Controller ', $cho == '1' ? 'Y' : null) . str_repeat (' ', CLI_LEN - strlen ('Controller') - 11) . cc ('â•‘', 'N') . "\n";
    echo cc ('â•‘', 'N') . ' ' . cc ($cho == '2' ? 'âœ' : ' ', 'y') . cc (' 2. ', $cho == '2' ? 'Y' : null) . cc ('â•‘', 'N') . cc (' Model ', $cho == '2' ? 'Y' : null) . str_repeat (' ', CLI_LEN - strlen ('Model') - 11) . cc ('â•‘', 'N') . "\n";
    echo cc ('â•‘', 'N') . ' ' . cc ($cho == '3' ? 'âœ' : ' ', 'y') . cc (' 3. ', $cho == '3' ? 'Y' : null) . cc ('â•‘', 'N') . cc (' Migration ', $cho == '3' ? 'Y' : null) . str_repeat (' ', CLI_LEN - strlen ('Migration') - 11) . cc ('â•‘', 'N') . "\n";
    echo cc ('â•Ÿ â”€ â”€ â”€â•‘â”€' . str_repeat (' â”€', (CLI_LEN - 9) / 2) . 'â•‘', 'N') . "\n";
    echo cc ('â•‘', 'N') . cc ('   q. ', 'W') . cc ('â•‘', 'N') . ' æ²’äº‹ï¼ŒæŒ‰éŒ¯.. é›¢é–‹æœ¬ç¨‹å¼ ' . str_repeat (' ', CLI_LEN - 23 - 11) . cc ('â•‘', 'N') . "\n";
    echo cc ('â•šâ•â•â•â•â•â•â•©' . str_repeat ('â•', CLI_LEN - 9) . 'â•', 'N') . "\n";
  }
}

do {
  headerText ();
  echo "\n";
  echo ' ' . cc ('âœ', 'R') . ' è«‹è¼¸å…¥æ‚¨çš„é¸é …' .  cc ('(q)', 'N') . 'ï¼š';

  ($cho = trim (fgets (STDIN))) || $cho = 'q';
} while (!in_array (strtolower ($cho), array ('1', '2', '3', 'q')));

if ($cho == 'q') {
  echo "\n";
  echo cc (str_repeat ('â•', CLI_LEN), 'N') . "\n\n";
  echo "  ğŸ˜Š  å¥½çš„ï¼ä¸‹æ¬¡åˆ¥å†æŒ‰éŒ¯å›‰ï¼ŒæœŸå¾…æ‚¨ä¸‹æ¬¡å†ä½¿ç”¨ï¼ŒğŸ‘‹  " . cc ('æ°æ°', 'W') . "ï½  \n\n";
  echo cc (str_repeat ('â•', CLI_LEN), 'N') . "\n\n";
  exit();
}

if ($cho == '3') {
  Load::sysCore ('Model.php', true);
  Load::sysLib ('MigrationTool.php', 'è¼‰å…¥ MigrationTool å¤±æ•—ï¼');
  MigrationTool::init ();

  $check = $name = '';
  do {
    headerText ('3');
    echo "\n";
    echo ' ' . cc ('âœ', 'R') . ' è«‹è¼¸å…¥è¦å»ºç«‹çš„æª”å' . cc ('(é›¢é–‹è«‹æŒ‰ control + c)', 'N') . 'ï¼š' . ($name ? $name . "\n" : '');

    if ($name || ($name = trim (fgets (STDIN)))) {
      echo "\n";
      echo ' ' . cc ('âœ', 'R') . ' æª”åã€Œ' . cc ($name, 'W') . 'ã€æ˜¯å¦æ­£ç¢º' . cc ('[Yï¼šæ²’éŒ¯, nï¼šä¸æ˜¯]', 'N') . 'ï¼Ÿ';
      ($check = strtolower (trim (fgets (STDIN)))) == 'n' && $name = '';
    }
  } while ($check != 'y');
  
  echo "\n";
  echo ' ' . cc ('â—', 'G') . ' Migrationã€Œ' . cc ($name, 'W') . 'ã€å»ºç«‹ä¸­.. ';

  if (!MigrationTool::create ($name, $err)) {
    echo cc ('å¤±æ•—ï¼', 'r') . "\n";
    echo "\n";
    echo ' ' . cc ('â—', 'G') . ' éŒ¯èª¤åŸå› ï¼š' . cc ($err, 'W');
    echo "\n";
    echo "\n";
    exit;
  }

  echo cc ('æˆåŠŸï¼', 'g') . "\n";
  echo "\n";
  echo ' ' . cc ('â—', 'G') . ' å·²ç¶“æˆåŠŸå»ºç«‹ Migrationï¼š' . cc ($err, 'W');
  echo "\n";
  echo "\n";
  exit;
}

